<!doctype html>
<html
  lang="{{ with site.Params.isoCode | default (site.LanguageCode | default `en`) }}{{- . -}}{{ end }}"
  dir="{{ cond (site.Params.rtl | default false) `rtl` `ltr` }}"
  class="scroll-smooth"
  data-default-appearance="{{ site.Params.defaultAppearance | default `light` }}"
  data-auto-appearance="{{ site.Params.autoSwitchAppearance | default `true` }}">
  {{- partial "head.html" . -}}
  {{- partialCached "init.html" . -}}

  {{ $bodyLayout := "flex flex-col h-screen leading-7 px-4 sm:px-8 lg:px-16 xl:px-20" }}
  {{ $bodyColor := "text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral" }}
  {{ $bodyScrollbar := "scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600" }}
  {{ $pageLayout := "" }}
  {{ if .IsHome }}
    {{ $pageLayout = "layout-home" }}
  {{ else if eq .Kind "page" }}
    {{ $pageLayout = "layout-article" }}
  {{ else }}
    {{ $pageLayout = "layout-list" }}
  {{ end }}
  <body class="{{ $bodyLayout }} {{ $bodyColor }} {{ $bodyScrollbar }} {{ $pageLayout }}">
    {{ if .IsHome }}
      <div id="loader-overlay" class="v0-loader-overlay">
        <div class="loader-content">
          <div class="terminal-boot-log" id="boot-log"></div>
          <div class="progress-wrapper">
            <div class="progress-label">
              <span>System Initialization</span>
              <span id="progress-pct">0%</span>
            </div>
            <div class="progress-bar-bg" id="progress-blocks-container"></div>
          </div>
        </div>
        <div class="access-granted" id="access-msg">ACCESS GRANTED</div>
      </div>
    {{ end }}
    <div id="the-top" class="absolute flex self-center">
      <a
        class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
        href="#main-content">
        <span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
        {{ i18n "nav.skip_to_main" }}
      </a>
    </div>

    {{ $header := print "header/" site.Params.header.layout ".html" }}
    {{ if templates.Exists ( printf "partials/%s" $header ) }}
      {{ partial $header . }}
    {{ else }}
      {{ partial "header/basic.html" . }}
    {{ end }}

    <div class="relative flex grow gap-0 lg:gap-10">
      {{ if not .IsHome }}
        {{ partial "sidebar/profile.html" . }}
      {{ end }}

      <div class="flex flex-col grow">
        <main id="main-content" class="grow pt-4 lg:pt-8">
          {{ block "main" . }}{{ end }}
          {{ if and (site.Params.footer.showScrollToTop | default true) }}
            {{- partial "scroll-to-top.html" . -}}
          {{ end }}
        </main>
        {{- partial "footer.html" . -}}
        {{ if site.Params.enableSearch | default false }}
          {{- partial "search.html" . -}}
        {{ end }}
      </div>
    </div>

    <script>
      (function () {
        var body = document.body;
        if (!body) return;

        var isHome = body.classList.contains('layout-home');
        var isArticle = body.classList.contains('layout-article');

        // 页面进入时触发导航动画：
        // 首页：顶部导航从上方淡入
        // 文章页：顶部导航上移淡出，左侧导航从左侧滑入
        if (isHome || isArticle) {
          window.setTimeout(function () {
            body.classList.add('nav-animate');
          }, 50);
        }

        // 侧边栏简介打字机效果
        var el = document.querySelector('.sidebar-typewriter');
        if (!el) return;
        var text = el.getAttribute('data-text') || el.textContent || '';
        text = text.trim();
        if (!text) return;
        el.textContent = '';
        var i = 0;
        function tick() {
          if (i <= text.length) {
            el.textContent = text.slice(0, i);
            i++;
            window.setTimeout(tick, 60);
          }
        }
        tick();
      })();

      (function () {
        var overlay = document.getElementById('loader-overlay');
        if (!overlay) return;

        var body = document.body;
        var isHome = body && body.classList.contains('layout-home');

        // 仅在首页首次访问时展示加载动画
        if (!isHome) {
          overlay.parentNode.removeChild(overlay);
          return;
        }

        try {
          if (window.sessionStorage && sessionStorage.getItem('v0_loader_shown') === '1') {
            overlay.parentNode.removeChild(overlay);
            return;
          }
        } catch (e) {
          // ignore storage errors
        }

        var logContainer = document.getElementById('boot-log');
        var blocksContainer = document.getElementById('progress-blocks-container');
        var progressText = document.getElementById('progress-pct');
        var accessMsg = document.getElementById('access-msg');

        var bootLogs = [
          'Initializing kernel...',
          'Loading modules: [crypto, net, fs]...',
          'Bypassing mainframe firewall...',
          '<span class="log-success">[OK]</span> Root access established',
          'Mounting file system /dev/sda1...',
          'Decrypting user interface config...',
          'Scanning for vulnerabilities...',
          '<span class="log-warn">[WARN]</span> Intrusion detection system disabled',
          'Loading graphical shell...',
          'Executing startup script: ./init_blog.sh...'
        ];

        var TOTAL_BLOCKS = 20;

        function initBlocks() {
          if (!blocksContainer) return;
          blocksContainer.innerHTML = '';
          for (var i = 0; i < TOTAL_BLOCKS; i++) {
            var block = document.createElement('div');
            block.className = 'progress-block';
            blocksContainer.appendChild(block);
          }
        }

        function updateBlocks(percent) {
          if (!blocksContainer) return;
          var blocksToFill = Math.floor((percent / 100) * TOTAL_BLOCKS);
          var blocks = blocksContainer.children;
          for (var i = 0; i < blocks.length; i++) {
            if (i < blocksToFill) {
              blocks[i].classList.add('active');
            }
          }
        }

        function startLoader() {
          initBlocks();

          var progress = 0;
          var logIndex = 0;

          var progressInterval = window.setInterval(function () {
            progress += Math.random() * 5 + 1;
            if (progress > 100) progress = 100;
            updateBlocks(progress);
            if (progressText) {
              progressText.innerText = String(Math.floor(progress)) + '%';
            }
            if (progress === 100) {
              window.clearInterval(progressInterval);
              finishLoading();
            }
          }, 40);

          var logInterval = window.setInterval(function () {
            if (!logContainer) {
              window.clearInterval(logInterval);
              return;
            }
            if (logIndex < bootLogs.length) {
              var line = document.createElement('div');
              line.className = 'log-line';
              line.innerHTML = '&gt; ' + bootLogs[logIndex];
              logContainer.appendChild(line);
              logContainer.scrollTop = logContainer.scrollHeight;
              logIndex++;
            } else {
              window.clearInterval(logInterval);
            }
          }, 90);
        }

        function finishLoading() {
          if (!overlay) return;
          window.setTimeout(function () {
            if (accessMsg) {
              accessMsg.style.display = 'block';
            }
            window.setTimeout(function () {
              overlay.style.transition = 'opacity 0.4s ease-out';
              overlay.style.opacity = '0';
            }, 600);
            window.setTimeout(function () {
              overlay.style.display = 'none';
            }, 1000);
          }, 120);
          try {
            if (window.sessionStorage) {
              sessionStorage.setItem('v0_loader_shown', '1');
            }
          } catch (e) {
            // ignore storage errors
          }
        }

        window.addEventListener('load', startLoader);
      })();
    </script>
  </body>
  {{ if site.Params.buymeacoffee.globalWidget | default false }}
    <script
      data-name="BMC-Widget"
      data-cfasync="false"
      src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js"
      data-id="{{ site.Params.buymeacoffee.identifier }}"
      data-description="Support me on Buy me a coffee!"
      {{ with site.Params.buymeacoffee.globalWidgetMessage }}data-message="{{ . }}"{{ end }}
      {{ with site.Params.buymeacoffee.globalWidgetColor | default `#FFDD00` }}data-color="{{ . }}"{{ end }}
      {{ with site.Params.buymeacoffee.globalWidgetPosition }}data-position="{{ . }}"{{ end }}
      data-x_margin="18"
      data-y_margin="18"></script>
  {{ end }}
</html>
